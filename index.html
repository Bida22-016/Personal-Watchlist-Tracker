<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CineTrack - Personal Watchlist & Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <style>
    /* Custom scrollbar for both themes */
    .light-scrollbar::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    .light-scrollbar::-webkit-scrollbar-track {
      background: rgba(241, 245, 249, 0.9);
    }
    .light-scrollbar::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.8);
      border-radius: 9999px;
    }
    .light-scrollbar::-webkit-scrollbar-thumb:hover {
      background: rgb(6, 182, 212);
    }
    
    .dark-scrollbar::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    .dark-scrollbar::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.9);
    }
    .dark-scrollbar::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.8);
      border-radius: 9999px;
    }
    .dark-scrollbar::-webkit-scrollbar-thumb:hover {
      background: rgb(168, 85, 247);
    }
    
    .backdrop-blur-2xl {
      backdrop-filter: blur(24px);
    }
    
    /* Netflix-style slider animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-out forwards;
    }
    
    .carousel-container {
      scroll-behavior: smooth;
    }
    
    /* Carousel item hover effects */
    .carousel-item {
      transition: all 0.3s ease;
    }
    
    .carousel-item:hover {
      transform: scale(1.05);
      z-index: 10;
    }
    
    .hero-slider {
      transition: transform 0.7s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Light mode transition */
    .theme-transition {
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }
  </style>
</head>
<body class="theme-transition bg-slate-50 text-slate-900 min-h-screen" id="theme-body">
  <noscript>
    <div class="p-4 bg-red-700 text-center text-white">
      This application requires JavaScript to run. Please enable JavaScript in your browser.
    </div>
  </noscript>
  <div id="root" class="min-h-screen"></div>

  <!-- React and Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel" data-presets="env,react">
    const { useState, useEffect, useMemo, useRef } = React;

    // ======== TMDB configuration ========
    const TMDB_API_KEY = '200c741200f7c835f871cf5126e5e6b2';
    const TMDB_BASE_URL = 'https://api.themoviedb.org/3';
    const TMDB_IMAGE_BASE = 'https://image.tmdb.org/t/p/';

    function buildImageUrl(path, size = 'w342') {
      if (!path) return null;
      return TMDB_IMAGE_BASE + size + path;
    }

    async function fetchFromTMDB(path, params = {}) {
      if (!TMDB_API_KEY || TMDB_API_KEY.startsWith('REPLACE_WITH')) {
        throw new Error('TMDB API key is not configured. Edit index.html and set TMDB_API_KEY.');
      }
      const url = new URL(TMDB_BASE_URL + path);
      const search = new URLSearchParams({
        api_key: TMDB_API_KEY,
        language: 'en-US',
        ...params,
      });
      url.search = search.toString();
      const response = await fetch(url.toString());
      let data;
      try {
        data = await response.json();
      } catch (e) {
        data = null;
      }
      if (!response.ok) {
        const message = (data && (data.status_message || data.message)) || response.statusText || 'Request failed';
        throw new Error(message);
      }
      return data;
    }

    // ======== Helpers ========

    function normalizeResults(results, forcedType = null) {
      if (!Array.isArray(results)) return [];
      return results
        .filter(raw => {
          const type = forcedType || raw.media_type || raw.type;
          return type === 'movie' || type === 'tv';
        })
        .map(raw => {
          const type = forcedType || raw.media_type || raw.type;
          const title = type === 'movie'
            ? (raw.title || raw.original_title || 'Untitled movie')
            : (raw.name || raw.original_name || 'Untitled TV show');
          const releaseDate = type === 'movie'
            ? (raw.release_date || null)
            : (raw.first_air_date || null);
          const year = releaseDate ? parseInt(releaseDate.slice(0, 4), 10) : null;
          const originCountry = raw.origin_country || [];
          return {
            id: raw.id,
            type,
            title,
            releaseDate,
            year,
            originCountry,
            genre_ids: raw.genre_ids || [],
            voteAverage: typeof raw.vote_average === 'number' ? raw.vote_average : 0,
            voteCount: typeof raw.vote_count === 'number' ? raw.vote_count : 0,
            adult: !!raw.adult,
            posterPath: raw.poster_path || null,
            backdropPath: raw.backdrop_path || null,
            overview: raw.overview || '',
            runtime: null,
            budget: null,
            revenue: null,
            certification: null,
            detailLoaded: false,
            detailError: null,
          };
        });
    }

    function extractCertification(raw, type, originCountryList) {
      const countryPriority = [];
      if (Array.isArray(originCountryList) && originCountryList.length > 0) {
        countryPriority.push(originCountryList[0]);
      }
      countryPriority.push('US', 'GB', 'CA', 'AU');
      const seen = new Set();
      const priority = countryPriority.filter(code => {
        if (!code) return false;
        const upper = code.toUpperCase();
        if (seen.has(upper)) return false;
        seen.add(upper);
        return true;
      });

      if (type === 'movie' && raw.release_dates && Array.isArray(raw.release_dates.results)) {
        const results = raw.release_dates.results;
        const findForCountry = (code) => {
          const entry = results.find(r => r.iso_3166_1 === code);
          if (!entry || !Array.isArray(entry.release_dates)) return null;
          const withCert = entry.release_dates.filter(r => r.certification);
          if (!withCert.length) return null;
          let chosen = withCert.find(r => r.type === 3) || withCert.find(r => r.type === 2) || withCert[0];
          return { code: chosen.certification, country: code };
        };
        for (const c of priority) {
          const hit = findForCountry(c);
          if (hit) return hit;
        }
        for (const entry of results) {
          if (!Array.isArray(entry.release_dates)) continue;
          const any = entry.release_dates.find(r => r.certification);
          if (any) {
            return { code: any.certification, country: entry.iso_3166_1 };
          }
        }
      }

      if (type === 'tv' && raw.content_ratings && Array.isArray(raw.content_ratings.results)) {
        const results = raw.content_ratings.results;
        const findForCountry = (code) => results.find(r => r.iso_3166_1 === code && r.rating);
        for (const c of priority) {
          const hit = findForCountry(c);
          if (hit) return { code: hit.rating, country: c };
        }
        const any = results.find(r => r.rating);
        if (any) {
          return { code: any.rating, country: any.iso_3166_1 };
        }
      }

      if (raw.adult) {
        return { code: '18+', country: priority[0] || null };
      }
      return { code: 'NR', country: null };
    }

    function extractTrailerKey(raw) {
      if (!raw.videos || !Array.isArray(raw.videos.results)) return null;
      const videos = raw.videos.results.filter(v => v.site === 'YouTube');
      if (!videos.length) return null;
      const officialTrailer = videos.find(v => v.type === 'Trailer' && v.official);
      if (officialTrailer) return officialTrailer.key;
      const anyTrailer = videos.find(v => v.type === 'Trailer');
      if (anyTrailer) return anyTrailer.key;
      const teaser = videos.find(v => v.type === 'Teaser');
      if (teaser) return teaser.key;
      return videos[0].key;
    }

    function formatRuntime(minutes) {
      if (!minutes || typeof minutes !== 'number') return 'Unknown';
      const h = Math.floor(minutes / 60);
      const m = minutes % 60;
      if (!h) return `${m} min`;
      if (!m) return `${h} h`;
      return `${h} h ${m} min`;
    }

    function formatMoney(amount) {
      if (!amount || typeof amount !== 'number') return 'Unknown';
      try {
        return new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD',
          notation: 'compact',
          maximumFractionDigits: 1,
        }).format(amount);
      } catch (e) {
        return `$${amount.toLocaleString()}`;
      }
    }

    function getCertificationStyle(certCode, darkMode) {
      const code = (certCode || '').toUpperCase();
      if (!code || code === 'NR') {
        return { label: 'NR', className: darkMode ? 'bg-slate-600 text-slate-50' : 'bg-slate-400 text-white' };
      }
      if (['G', 'TV-Y', 'TV-G', 'U'].includes(code)) {
        return { label: code, className: 'bg-emerald-500 text-emerald-950' };
      }
      if (['PG', 'PG-13', 'TV-PG', 'TV-Y7', '12', '12A', '6', '7+'].includes(code)) {
        return { label: code, className: 'bg-yellow-400 text-yellow-950' };
      }
      if (['R', 'NC-17', 'TV-14', 'TV-MA', '18', '18+', '16'].includes(code)) {
        return { label: code, className: 'bg-red-500 text-red-50' };
      }
      return { label: code, className: darkMode ? 'bg-slate-300 text-slate-900' : 'bg-slate-200 text-slate-900' };
    }

    function getItemKey(item) {
      return item ? `${item.type}_${item.id}` : '';
    }

    const WATCH_STATUSES = [
      { id: 'watching', label: 'Watching' },
      { id: 'onHold', label: 'On-Hold' },
      { id: 'plan', label: 'Plan to Watch' },
      { id: 'dropped', label: 'Dropped' },
      { id: 'completed', label: 'Completed' },
    ];

    function loadWatchlistFromStorage() {
      try {
        const raw = localStorage.getItem('watchlist_v1');
        if (!raw) return {};
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== 'object') return {};
        return parsed;
      } catch (e) {
        console.warn('Failed to parse watchlist from storage', e);
        return {};
      }
    }

    // ======== New UI Components ========

    function ThemeToggle({ darkMode, onToggle }) {
      return (
        <button
          onClick={onToggle}
          className={`relative inline-flex h-8 w-16 items-center rounded-full p-1 transition-colors ${darkMode ? 'bg-purple-600' : 'bg-cyan-500'}`}
          aria-label={`Switch to ${darkMode ? 'light' : 'dark'} mode`}
        >
          <span
            className={`inline-block h-6 w-6 transform rounded-full bg-white shadow-lg transition-transform ${darkMode ? 'translate-x-8' : 'translate-x-0'}`}
          >
            <span className="flex h-full w-full items-center justify-center">
              {darkMode ? 'üåô' : '‚òÄÔ∏è'}
            </span>
          </span>
        </button>
      );
    }

    function HeroSlider({ items, onOpenDetails, darkMode }) {
      const [currentIndex, setCurrentIndex] = useState(0);
      const sliderRef = useRef(null);
      
      useEffect(() => {
        const interval = setInterval(() => {
          setCurrentIndex((prev) => (prev + 1) % Math.min(5, items.length));
        }, 5000);
        return () => clearInterval(interval);
      }, [items.length]);
      
      if (!items || items.length === 0) return null;
      
      const featuredItems = items.slice(0, 5);
      const currentItem = featuredItems[currentIndex];
      const backdropUrl = buildImageUrl(currentItem?.backdropPath, 'w1280');
      
      return (
        <div className="relative h-[400px] sm:h-[500px] md:h-[600px] w-full overflow-hidden rounded-2xl mb-8">
          {/* Background image */}
          {backdropUrl ? (
            <div className="absolute inset-0">
              <img
                src={backdropUrl}
                alt={currentItem.title}
                className="h-full w-full object-cover"
              />
              <div className={`absolute inset-0 ${darkMode ? 'bg-gradient-to-t from-slate-950 via-slate-950/70 to-transparent' : 'bg-gradient-to-t from-white via-white/70 to-transparent'}`} />
            </div>
          ) : (
            <div className={`absolute inset-0 ${darkMode ? 'bg-gradient-to-r from-slate-900 via-purple-900/30 to-slate-900' : 'bg-gradient-to-r from-slate-100 via-cyan-100/30 to-slate-100'}`} />
          )}
          
          {/* Content */}
          <div className="relative h-full flex flex-col justify-end p-6 md:p-10">
            <div className="max-w-3xl fade-in">
              <h2 className="text-3xl md:text-4xl lg:text-5xl font-bold mb-3 drop-shadow-lg" style={{ color: darkMode ? 'white' : 'rgb(15 23 42)' }}>
                {currentItem.title}
              </h2>
              <p className={`text-lg mb-4 line-clamp-3 ${darkMode ? 'text-slate-200' : 'text-slate-700'}`}>
                {currentItem.overview || 'No description available.'}
              </p>
              <div className="flex flex-wrap gap-2 mb-6">
                <span className={`inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold ${darkMode ? 'bg-purple-600 text-white' : 'bg-cyan-500 text-white'}`}>
                  {currentItem.type === 'movie' ? 'Movie' : 'TV Series'}
                </span>
                {currentItem.year && (
                  <span className={`inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold ${darkMode ? 'bg-slate-700 text-white' : 'bg-slate-300 text-slate-900'}`}>
                    {currentItem.year}
                  </span>
                )}
                <span className="inline-flex items-center gap-1 rounded-full bg-black/50 px-3 py-1 text-xs font-semibold text-white">
                  <span className="text-yellow-300">‚òÖ</span>
                  <span>{currentItem.voteAverage ? currentItem.voteAverage.toFixed(1) : 'N/A'}</span>
                </span>
              </div>
              <div className="flex gap-3">
                <button
                  onClick={() => onOpenDetails(currentItem)}
                  className={`px-6 py-3 rounded-lg font-semibold transition ${darkMode ? 'bg-purple-600 hover:bg-purple-700 text-white' : 'bg-cyan-500 hover:bg-cyan-600 text-white'}`}
                >
                  View Details
                </button>
                <button
                  onClick={() => onOpenDetails(currentItem)}
                  className={`px-6 py-3 rounded-lg font-semibold border ${darkMode ? 'border-white text-white hover:bg-white/10' : 'border-slate-900 text-slate-900 hover:bg-slate-100'}`}
                >
                  ‚ñ∂ Play Trailer
                </button>
              </div>
            </div>
          </div>
          
          {/* Indicators */}
          <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex gap-2">
            {featuredItems.map((_, index) => (
              <button
                key={index}
                onClick={() => setCurrentIndex(index)}
                className={`h-2 rounded-full transition-all ${index === currentIndex ? (darkMode ? 'bg-purple-500 w-8' : 'bg-cyan-500 w-8') : (darkMode ? 'bg-white/50 w-2' : 'bg-slate-400 w-2')}`}
                aria-label={`Go to slide ${index + 1}`}
              />
            ))}
          </div>
        </div>
      );
    }

    function CarouselSection({ title, items, onOpenDetails, genreLookup, darkMode, accentColor }) {
      const carouselRef = useRef(null);
      
      const scroll = (direction) => {
        if (carouselRef.current) {
          const scrollAmount = 320;
          carouselRef.current.scrollBy({
            left: direction === 'left' ? -scrollAmount : scrollAmount,
            behavior: 'smooth'
          });
        }
      };
      
      if (!items || items.length === 0) return null;
      
      return (
        <section className="mb-10 fade-in">
          <div className="flex items-center justify-between mb-4">
            <h2 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-slate-900'}`}>
              {title}
            </h2>
            <div className="flex gap-2">
              <button
                onClick={() => scroll('left')}
                className={`p-2 rounded-full ${darkMode ? 'bg-slate-800 hover:bg-slate-700 text-white' : 'bg-slate-200 hover:bg-slate-300 text-slate-900'}`}
                aria-label="Scroll left"
              >
                ‚Äπ
              </button>
              <button
                onClick={() => scroll('right')}
                className={`p-2 rounded-full ${darkMode ? 'bg-slate-800 hover:bg-slate-700 text-white' : 'bg-slate-200 hover:bg-slate-300 text-slate-900'}`}
                aria-label="Scroll right"
              >
                ‚Ä∫
              </button>
            </div>
          </div>
          
          <div
            ref={carouselRef}
            className="carousel-container flex gap-4 overflow-x-auto pb-4"
            style={{ scrollbarWidth: 'none', msOverflowStyle: 'none' }}
          >
            {items.map((item) => {
              const posterUrl = buildImageUrl(item.posterPath, 'w342');
              const certStyle = getCertificationStyle(item.certification?.code || (item.adult ? '18+' : 'NR'), darkMode);
              
              return (
                <div
                  key={getItemKey(item)}
                  className="carousel-item flex-shrink-0 w-48 cursor-pointer"
                  onClick={() => onOpenDetails(item)}
                >
                  <div className={`relative rounded-xl overflow-hidden shadow-lg ${darkMode ? 'bg-slate-800' : 'bg-white'} border ${darkMode ? 'border-slate-700' : 'border-slate-200'}`}>
                    <div className="aspect-[2/3] overflow-hidden">
                      {posterUrl ? (
                        <img
                          src={posterUrl}
                          alt={item.title}
                          className="h-full w-full object-cover transition-transform duration-300 hover:scale-110"
                        />
                      ) : (
                        <div className={`h-full w-full flex items-center justify-center ${darkMode ? 'bg-slate-700' : 'bg-slate-100'}`}>
                          <span className={darkMode ? 'text-slate-400' : 'text-slate-500'}>No image</span>
                        </div>
                      )}
                    </div>
                    <div className="absolute top-2 left-2">
                      <div className={`inline-flex items-center gap-1 rounded-full px-2 py-1 text-xs font-semibold ${certStyle.className}`}>
                        {certStyle.label}
                      </div>
                    </div>
                    <div className="absolute top-2 right-2">
                      <div className={`inline-flex items-center gap-1 rounded-full px-2 py-1 text-xs font-semibold ${darkMode ? 'bg-slate-900/80 text-white' : 'bg-white/90 text-slate-900'}`}>
                        {item.type === 'movie' ? 'Movie' : 'TV'}
                      </div>
                    </div>
                    <div className="p-3">
                      <h3 className={`font-semibold truncate ${darkMode ? 'text-white' : 'text-slate-900'}`}>
                        {item.title}
                      </h3>
                      <div className="flex items-center justify-between mt-2">
                        <span className={`text-sm ${darkMode ? 'text-slate-300' : 'text-slate-600'}`}>
                          {item.year || 'N/A'}
                        </span>
                        <div className="flex items-center gap-1">
                          <span className="text-yellow-500">‚òÖ</span>
                          <span className={`text-sm font-medium ${darkMode ? 'text-white' : 'text-slate-900'}`}>
                            {item.voteAverage ? item.voteAverage.toFixed(1) : 'N/A'}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        </section>
      );
    }

    function StatusSelector({ status, onChange, darkMode }) {
      return (
        <select
          value={status || ''}
          onChange={e => onChange(e.target.value || null)}
          className={`w-full text-xs rounded-md ${darkMode ? 'bg-slate-800 border-slate-700 text-slate-100' : 'bg-white border-slate-300 text-slate-900'} border px-2 py-1 focus:outline-none focus:ring-2 ${darkMode ? 'focus:ring-purple-500' : 'focus:ring-cyan-500'}`}
        >
          <option value="">No status</option>
          {WATCH_STATUSES.map(s => (
            <option key={s.id} value={s.id}>{s.label}</option>
          ))}
        </select>
      );
    }

    function ItemCard({ item, genreLookup, onOpenDetails, watchStatus, onChangeStatus, darkMode }) {
      const posterUrl = buildImageUrl(item.posterPath, 'w342');
      const certification = item.certification || (item.adult ? { code: '18+', country: null } : { code: 'NR', country: null });
      const certStyle = getCertificationStyle(certification.code, darkMode);
      const genreNames = (item.genre_ids || [])
        .map(id => genreLookup[id])
        .filter(Boolean)
        .slice(0, 3);

      const accentColor = darkMode ? 'rgb(168 85 247)' : 'rgb(6 182 212)';
      const accentHover = darkMode ? 'rgb(147 51 234)' : 'rgb(8 145 178)';

      return (
        <div className={`group flex flex-col rounded-xl ${darkMode ? 'bg-slate-900/70 border-slate-800 hover:border-purple-500/80' : 'bg-white border-slate-200 hover:border-cyan-500/80'} border hover:shadow-xl overflow-hidden transition`}>
          <button
            type="button"
            onClick={() => onOpenDetails(item)}
            className={`relative w-full aspect-[2/3] ${darkMode ? 'bg-slate-800' : 'bg-slate-100'} overflow-hidden`}
          >
            {posterUrl ? (
              <img
                src={posterUrl}
                alt={item.title}
                loading="lazy"
                className="h-full w-full object-cover group-hover:scale-[1.03] transition-transform duration-300"
              />
            ) : (
              <div className={`flex h-full w-full items-center justify-center ${darkMode ? 'bg-gradient-to-br from-slate-700 to-slate-900 text-slate-300' : 'bg-gradient-to-br from-slate-200 to-slate-300 text-slate-600'} text-xs p-4 text-center`}>
                No poster available
              </div>
            )}
            <div className="absolute top-2 left-2 flex flex-col gap-1">
              <div className={`inline-flex items-center gap-1 rounded-full ${darkMode ? 'bg-slate-900/80 text-slate-50' : 'bg-white/90 text-slate-900'} px-2 py-0.5 text-[11px] font-medium`}>
                <span className="text-yellow-300">‚òÖ</span>
                <span>{item.voteAverage ? item.voteAverage.toFixed(1) : 'N/A'}</span>
                <span className={`text-[10px] ${darkMode ? 'text-slate-300' : 'text-slate-600'}`}>({item.voteCount || 0})</span>
              </div>
              <div className={`inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[11px] font-semibold ${certStyle.className}`}>
                <span>{certStyle.label}</span>
              </div>
            </div>
            <div className="absolute top-2 right-2">
              <span className={`inline-flex items-center rounded-full ${darkMode ? 'bg-slate-900/80 text-slate-100' : 'bg-white/90 text-slate-900'} px-2 py-0.5 text-[11px] font-semibold`}>
                {item.type === 'movie' ? 'Movie' : 'TV'}
              </span>
            </div>
          </button>

          <div className="flex flex-col gap-2 p-3 sm:p-3.5">
            <div className="flex items-start justify-between gap-2">
              <div className="min-w-0">
                <h3
                  className={`truncate text-sm font-semibold ${darkMode ? 'text-slate-50' : 'text-slate-900'}`}
                  title={item.title}
                >
                  {item.title}
                </h3>
                <div className="mt-0.5 flex flex-wrap items-center gap-1 text-[11px]">
                  {item.year && <span className={darkMode ? 'text-slate-400' : 'text-slate-600'}>{item.year}</span>}
                  {item.originCountry && item.originCountry.length > 0 && (
                    <>
                      <span className={darkMode ? 'text-slate-600' : 'text-slate-400'}>‚Ä¢</span>
                      <span className={darkMode ? 'text-slate-400' : 'text-slate-600'}>{item.originCountry.join(', ')}</span>
                    </>
                  )}
                </div>
              </div>
            </div>

            <div className="flex flex-wrap gap-1">
              {genreNames.map(name => (
                <span
                  key={name}
                  className={`rounded-full ${darkMode ? 'bg-slate-800/90 text-slate-200' : 'bg-slate-100 text-slate-700'} px-2 py-0.5 text-[10px]`}
                >
                  {name}
                </span>
              ))}
              {genreNames.length === 0 && (
                <span className={`rounded-full ${darkMode ? 'bg-slate-800/90 text-slate-400' : 'bg-slate-100 text-slate-500'} px-2 py-0.5 text-[10px]`}>
                  No genres
                </span>
              )}
            </div>

            <div className="mt-1 flex flex-col gap-2">
              <div className="flex items-center gap-2">
                {!watchStatus && (
                  <button
                    type="button"
                    onClick={() => onChangeStatus('plan')}
                    className={`flex-1 rounded-md px-2.5 py-1 text-[11px] font-semibold transition`}
                    style={{ backgroundColor: accentColor, color: 'white' }}
                    onMouseEnter={(e) => e.target.style.backgroundColor = accentHover}
                    onMouseLeave={(e) => e.target.style.backgroundColor = accentColor}
                  >
                    Add to Plan to Watch
                  </button>
                )}
                {watchStatus && (
                  <span className={`inline-flex items-center rounded-md px-2 py-1 text-[11px] font-medium border ${darkMode ? 'bg-emerald-500/10 border-emerald-500/40 text-emerald-300' : 'bg-emerald-100 border-emerald-300 text-emerald-700'}`}>
                    In watchlist: {WATCH_STATUSES.find(s => s.id === watchStatus)?.label || 'Unknown'}
                  </span>
                )}
              </div>
              <StatusSelector status={watchStatus} onChange={onChangeStatus} darkMode={darkMode} />
            </div>
          </div>
        </div>
      );
    }

    function DetailModal({ item, onClose, loading, error, darkMode }) {
      if (!item) return null;

      const posterUrl = buildImageUrl(item.posterPath, 'w500');
      const backdropUrl = buildImageUrl(item.backdropPath, 'w1280');
      const certification = item.certification || (item.adult ? { code: '18+', country: null } : { code: 'NR', country: null });
      const certStyle = getCertificationStyle(certification.code, darkMode);
      const runtimeLabel = item.runtime ? formatRuntime(item.runtime) : (item.type === 'tv' ? 'Per episode: Unknown' : 'Unknown');
      const budgetLabel = item.type === 'movie' ? formatMoney(item.budget) : 'N/A';
      const revenueLabel = item.type === 'movie' ? formatMoney(item.revenue) : 'N/A';
      const genres = (item.genresFull || []).map(g => g.name).filter(Boolean);
      const countryLabel = Array.isArray(item.originCountry) && item.originCountry.length
        ? item.originCountry.join(', ')
        : 'Unknown';

      const accentColor = darkMode ? 'rgb(168 85 247)' : 'rgb(6 182 212)';

      return (
        <div className={`fixed inset-0 z-40 flex items-start justify-center overflow-y-auto ${darkMode ? 'bg-black/80' : 'bg-black/60'} py-8 px-4 sm:px-6`}>
          <div className={`relative w-full max-w-5xl rounded-2xl ${darkMode ? 'bg-slate-950/95 border-slate-800' : 'bg-white/95 border-slate-300'} border shadow-2xl shadow-black/60 backdrop-blur-2xl`}>
            <button
              type="button"
              onClick={onClose}
              className={`absolute right-4 top-4 inline-flex h-8 w-8 items-center justify-center rounded-full ${darkMode ? 'bg-slate-900/80 text-slate-200 hover:bg-slate-800' : 'bg-white/80 text-slate-900 hover:bg-white'} focus:outline-none focus:ring-2`}
              style={{ focusRingColor: accentColor }}
            >
              ‚úï
            </button>

            <div className="relative">
              {backdropUrl ? (
                <div className="h-48 w-full overflow-hidden rounded-t-2xl bg-slate-900 sm:h-56 md:h-64">
                  <img
                    src={backdropUrl}
                    alt={item.title}
                    className="h-full w-full object-cover opacity-60"
                  />
                </div>
              ) : (
                <div className={`h-40 w-full rounded-t-2xl ${darkMode ? 'bg-gradient-to-r from-slate-900 via-purple-900/30 to-slate-900' : 'bg-gradient-to-r from-slate-100 via-cyan-100/30 to-slate-100'}`} />
              )}
              <div className={`absolute inset-0 rounded-t-2xl ${darkMode ? 'bg-gradient-to-t from-slate-950 via-slate-950/80 to-slate-950/10' : 'bg-gradient-to-t from-white via-white/80 to-white/10'}`} />
            </div>

            <div className="relative -mt-16 px-4 pb-5 sm:px-6 md:px-8 md:pb-8">
              <div className="grid gap-6 md:grid-cols-[minmax(0,2fr)_minmax(0,3fr)]">
                <div className="flex flex-col gap-4">
                  <div className="relative w-40 sm:w-48 md:w-56 -mt-4">
                    <div className={`overflow-hidden rounded-2xl border ${darkMode ? 'border-slate-800 bg-slate-900' : 'border-slate-300 bg-white'} shadow-xl shadow-black/60`}>
                      {posterUrl ? (
                        <img
                          src={posterUrl}
                          alt={item.title}
                          className="w-full"
                        />
                      ) : (
                        <div className={`flex aspect-[2/3] items-center justify-center ${darkMode ? 'bg-gradient-to-br from-slate-800 to-slate-900 text-slate-300' : 'bg-gradient-to-br from-slate-200 to-slate-300 text-slate-600'} text-sm p-4 text-center`}>
                          No poster available
                        </div>
                      )}
                    </div>
                  </div>

                  <div className="flex flex-col gap-2 text-sm">
                    <div className="flex flex-wrap items-center gap-2">
                      <span className={`inline-flex items-center gap-1 rounded-full px-3 py-1 text-xs font-semibold ${certStyle.className}`}>
                        <span>{certStyle.label}</span>
                        {certification.country && (
                          <span className="text-[10px] opacity-80">({certification.country})</span>
                        )}
                      </span>
                      <span className={`inline-flex items-center rounded-full px-3 py-1 text-xs font-medium ${darkMode ? 'bg-slate-800 text-slate-200' : 'bg-slate-200 text-slate-900'}`}>
                        {item.type === 'movie' ? 'Movie' : 'TV Series'}
                      </span>
                      {item.year && (
                        <span className={`inline-flex items-center rounded-full px-3 py-1 text-xs ${darkMode ? 'bg-slate-800 text-slate-200' : 'bg-slate-200 text-slate-900'}`}>
                          {item.year}
                        </span>
                      )}
                    </div>

                    <div className="grid grid-cols-2 gap-3 text-xs sm:text-[13px]">
                      <div className="space-y-1">
                        <div className={darkMode ? 'text-slate-400' : 'text-slate-600'}>Runtime</div>
                        <div className={`font-medium ${darkMode ? 'text-slate-100' : 'text-slate-900'}`}>{runtimeLabel}</div>
                      </div>
                      <div className="space-y-1">
                        <div className={darkMode ? 'text-slate-400' : 'text-slate-600'}>Country</div>
                        <div className={`font-medium ${darkMode ? 'text-slate-100' : 'text-slate-900'}`}>{countryLabel}</div>
                      </div>
                      <div className="space-y-1">
                        <div className={darkMode ? 'text-slate-400' : 'text-slate-600'}>TMDB Rating</div>
                        <div className={`flex items-center gap-1 font-medium ${darkMode ? 'text-slate-100' : 'text-slate-900'}`}>
                          <span className="text-yellow-300">‚òÖ</span>
                          <span>{item.voteAverage ? item.voteAverage.toFixed(1) : 'N/A'}</span>
                          <span className={`text-xs ${darkMode ? 'text-slate-400' : 'text-slate-600'}`}>({item.voteCount || 0} votes)</span>
                        </div>
                      </div>
                      <div className="space-y-1">
                        <div className={darkMode ? 'text-slate-400' : 'text-slate-600'}>Release Year</div>
                        <div className={`font-medium ${darkMode ? 'text-slate-100' : 'text-slate-900'}`}>{item.year || 'Unknown'}</div>
                      </div>
                      <div className="space-y-1">
                        <div className={darkMode ? 'text-slate-400' : 'text-slate-600'}>Budget (movies)</div>
                        <div className={`font-medium ${darkMode ? 'text-slate-100' : 'text-slate-900'}`}>{budgetLabel}</div>
                      </div>
                      <div className="space-y-1">
                        <div className={darkMode ? 'text-slate-400' : 'text-slate-600'}>Lifetime Gross (movies)</div>
                        <div className={`font-medium ${darkMode ? 'text-slate-100' : 'text-slate-900'}`}>{revenueLabel}</div>
                      </div>
                    </div>

                    {genres.length > 0 && (
                      <div className="mt-1">
                        <div className={`text-xs mb-1 ${darkMode ? 'text-slate-400' : 'text-slate-600'}`}>Genres</div>
                        <div className="flex flex-wrap gap-1.5">
                          {genres.map(name => (
                            <span
                              key={name}
                              className={`rounded-full px-2.5 py-0.5 text-[11px] ${darkMode ? 'bg-slate-800 text-slate-100' : 'bg-slate-200 text-slate-900'}`}
                            >
                              {name}
                            </span>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                <div className="flex flex-col gap-4">
                  <div>
                    <h2 className={`text-xl sm:text-2xl font-semibold ${darkMode ? 'text-slate-50' : 'text-slate-900'}`}>
                      {item.title}
                    </h2>
                  </div>

                  <div className={`space-y-2 text-sm leading-relaxed max-h-52 overflow-y-auto pr-1 ${darkMode ? 'text-slate-200' : 'text-slate-700'}`}>
                    <div className="text-xs font-semibold uppercase tracking-wide" style={{ color: accentColor }}>
                      Synopsis
                    </div>
                    <p>
                      {item.overview || 'No overview available for this title.'}
                    </p>
                  </div>

                  <div className="mt-2">
                    <div className="text-xs font-semibold uppercase tracking-wide mb-2" style={{ color: accentColor }}>
                      Trailer
                    </div>
                    {loading && !item.detailLoaded && (
                      <div className={`flex h-48 items-center justify-center rounded-xl border ${darkMode ? 'border-slate-800 bg-slate-900 text-slate-300' : 'border-slate-300 bg-slate-100 text-slate-600'} text-sm`}>
                        Loading trailer and details...
                      </div>
                    )}
                    {error && (
                      <div className={`rounded-xl border px-3 py-2 text-xs ${darkMode ? 'border-red-500/70 bg-red-950/40 text-red-200' : 'border-red-500/70 bg-red-100 text-red-800'}`}>
                        {error}
                      </div>
                    )}
                    {!loading && item.trailerKey && (
                      <div className="aspect-video w-full overflow-hidden rounded-xl border border-slate-800 bg-black">
                        <iframe
                          src={`https://www.youtube.com/embed/${item.trailerKey}`}
                          title={`${item.title} trailer`}
                          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                          allowFullScreen
                          className="h-full w-full"
                          loading="lazy"
                        />
                      </div>
                    )}
                    {!loading && !item.trailerKey && !error && (
                      <div className={`flex h-40 items-center justify-center rounded-xl border ${darkMode ? 'border-slate-800 bg-slate-900 text-slate-300' : 'border-slate-300 bg-slate-100 text-slate-600'} text-sm`}>
                        No trailer available for this title.
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function FiltersPanel({
      genres,
      filters,
      onUpdateFilters,
      contentType,
      onChangeContentType,
      browseMode,
      onChangeBrowseMode,
      availableCountries,
      onClearFilters,
      darkMode
    }) {
      const [open, setOpen] = useState(true);

      const handleCheckboxGenre = (id) => {
        const current = filters.selectedGenres || [];
        if (current.includes(id)) {
          onUpdateFilters({ selectedGenres: current.filter(x => x !== id) });
        } else {
          onUpdateFilters({ selectedGenres: [...current, id] });
        }
      };

      const handleNumericChange = (key, value) => {
        const trimmed = value.trim();
        if (!trimmed) {
          onUpdateFilters({ [key]: '' });
        } else {
          const num = Number(trimmed);
          if (!Number.isNaN(num)) {
            onUpdateFilters({ [key]: num });
          }
        }
      };

      const accentColor = darkMode ? 'rgb(168 85 247)' : 'rgb(6 182 212)';
      const accentHover = darkMode ? 'rgb(147 51 234)' : 'rgb(8 145 178)';

      return (
        <div className="space-y-3">
          <div className={`rounded-xl border ${darkMode ? 'border-slate-800 bg-slate-900/80' : 'border-slate-300 bg-slate-100/80'} p-3 sm:p-4`}>
            <div className="mb-3">
              <div className={`text-xs font-semibold uppercase tracking-wide mb-1 ${darkMode ? 'text-slate-400' : 'text-slate-600'}`}>
                Content type
              </div>
              <div className={`inline-flex rounded-lg ${darkMode ? 'bg-slate-800' : 'bg-slate-200'} p-0.5 text-xs`}>
                {[
                  { id: 'all', label: 'All' },
                  { id: 'movie', label: 'Movies' },
                  { id: 'tv', label: 'TV Shows' },
                ].map(opt => (
                  <button
                    key={opt.id}
                    type="button"
                    onClick={() => onChangeContentType(opt.id)}
                    className={
                      'px-2.5 py-1 rounded-md font-medium transition ' +
                      (contentType === opt.id
                        ? 'text-white shadow-sm'
                        : `${darkMode ? 'text-slate-200 hover:bg-slate-700' : 'text-slate-700 hover:bg-slate-300'}`)
                    }
                    style={contentType === opt.id ? { backgroundColor: accentColor } : {}}
                  >
                    {opt.label}
                  </button>
                ))}
              </div>
            </div>

            <div>
              <div className={`text-xs font-semibold uppercase tracking-wide mb-1 ${darkMode ? 'text-slate-400' : 'text-slate-600'}`}>
                Browse mode
              </div>
              <div className={`inline-flex rounded-lg ${darkMode ? 'bg-slate-800' : 'bg-slate-200'} p-0.5 text-xs`}>
                {[
                  { id: 'popular', label: 'Popular / Trending' },
                  { id: 'upcoming', label: 'Upcoming' },
                ].map(opt => (
                  <button
                    key={opt.id}
                    type="button"
                    onClick={() => onChangeBrowseMode(opt.id)}
                    className={
                      'px-2.5 py-1 rounded-md font-medium transition text-[11px] ' +
                      (browseMode === opt.id
                        ? 'text-white shadow-sm'
                        : `${darkMode ? 'text-slate-200 hover:bg-slate-700' : 'text-slate-700 hover:bg-slate-300'}`)
                    }
                    style={browseMode === opt.id ? { backgroundColor: accentColor } : {}}
                  >
                    {opt.label}
                  </button>
                ))}
              </div>
            </div>
          </div>

          <div className={`rounded-xl border ${darkMode ? 'border-slate-800 bg-slate-900/80' : 'border-slate-300 bg-slate-100/80'}`}>
            <button
              type="button"
              onClick={() => setOpen(o => !o)}
              className={`flex w-full items-center justify-between px-3 py-2.5 text-xs font-semibold uppercase tracking-wide ${darkMode ? 'text-slate-300 hover:bg-slate-800/80' : 'text-slate-700 hover:bg-slate-200/80'}`}
            >
              <span>Advanced filters</span>
              <span className={darkMode ? 'text-slate-400' : 'text-slate-500'}>
                {open ? 'Hide' : 'Show'}
              </span>
            </button>
            {open && (
              <div className={`border-t ${darkMode ? 'border-slate-800' : 'border-slate-300'} px-3 py-3 space-y-3 text-xs`}>
                <div className="space-y-2">
                  <div className={`font-semibold ${darkMode ? 'text-slate-300' : 'text-slate-700'}`}>Genres</div>
                  <div className="grid grid-cols-2 gap-1.5">
                    {genres.map(g => (
                      <label key={g.id} className={`inline-flex items-center gap-1.5 text-[11px] ${darkMode ? 'text-slate-200' : 'text-slate-700'}`}>
                        <input
                          type="checkbox"
                          className={`h-3.5 w-3.5 rounded ${darkMode ? 'border-slate-600 bg-slate-900' : 'border-slate-400 bg-white'} focus:ring-2`}
                          style={{ '--tw-ring-color': accentColor }}
                          checked={filters.selectedGenres?.includes(g.id) || false}
                          onChange={() => handleCheckboxGenre(g.id)}
                        />
                        <span>{g.name}</span>
                      </label>
                    ))}
                    {genres.length === 0 && (
                      <div className={`text-[11px] ${darkMode ? 'text-slate-400' : 'text-slate-500'}`}>
                        Genres will appear once the API configuration is valid.
                      </div>
                    )}
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-3">
                  <div className="space-y-1.5">
                    <div className={`font-semibold ${darkMode ? 'text-slate-300' : 'text-slate-700'}`}>Rating (0‚Äì10)</div>
                    <div className="flex items-center gap-1">
                      <input
                        type="number"
                        min="0"
                        max="10"
                        step="0.5"
                        value={filters.ratingMin === '' ? '' : filters.ratingMin}
                        onChange={e => handleNumericChange('ratingMin', e.target.value)}
                        className={`w-16 rounded-md border ${darkMode ? 'border-slate-700 bg-slate-900 text-slate-100' : 'border-slate-300 bg-white text-slate-900'} px-1.5 py-0.5 text-[11px] focus:outline-none focus:ring-1`}
                        style={{ '--tw-ring-color': accentColor }}
                        placeholder="Min"
                      />
                      <span className={`text-[11px] ${darkMode ? 'text-slate-500' : 'text-slate-400'}`}>to</span>
                      <input
                        type="number"
                        min="0"
                        max="10"
                        step="0.5"
                        value={filters.ratingMax === '' ? '' : filters.ratingMax}
                        onChange={e => handleNumericChange('ratingMax', e.target.value)}
                        className={`w-16 rounded-md border ${darkMode ? 'border-slate-700 bg-slate-900 text-slate-100' : 'border-slate-300 bg-white text-slate-900'} px-1.5 py-0.5 text-[11px] focus:outline-none focus:ring-1`}
                        style={{ '--tw-ring-color': accentColor }}
                        placeholder="Max"
                      />
                    </div>
                  </div>

                  <div className="space-y-1.5">
                    <div className={`font-semibold ${darkMode ? 'text-slate-300' : 'text-slate-700'}`}>Release year</div>
                    <div className="flex items-center gap-1">
                      <input
                        type="number"
                        value={filters.yearMin === '' ? '' : filters.yearMin}
                        onChange={e => handleNumericChange('yearMin', e.target.value)}
                        className={`w-20 rounded-md border ${darkMode ? 'border-slate-700 bg-slate-900 text-slate-100' : 'border-slate-300 bg-white text-slate-900'} px-1.5 py-0.5 text-[11px] focus:outline-none focus:ring-1`}
                        style={{ '--tw-ring-color': accentColor }}
                        placeholder="From"
                      />
                      <span className={`text-[11px] ${darkMode ? 'text-slate-500' : 'text-slate-400'}`}>to</span>
                      <input
                        type="number"
                        value={filters.yearMax === '' ? '' : filters.yearMax}
                        onChange={e => handleNumericChange('yearMax', e.target.value)}
                        className={`w-20 rounded-md border ${darkMode ? 'border-slate-700 bg-slate-900 text-slate-100' : 'border-slate-300 bg-white text-slate-900'} px-1.5 py-0.5 text-[11px] focus:outline-none focus:ring-1`}
                        style={{ '--tw-ring-color': accentColor }}
                        placeholder="To"
                      />
                    </div>
                  </div>
                </div>

                <div className="space-y-1.5">
                  <div className={`font-semibold ${darkMode ? 'text-slate-300' : 'text-slate-700'}`}>Country (ISO code)</div>
                  <input
                    type="text"
                    maxLength={2}
                    value={filters.country}
                    onChange={e => onUpdateFilters({ country: e.target.value.toUpperCase() })}
                    className={`w-20 rounded-md border ${darkMode ? 'border-slate-700 bg-slate-900 text-slate-100' : 'border-slate-300 bg-white text-slate-900'} px-1.5 py-0.5 text-[11px] focus:outline-none focus:ring-1`}
                    style={{ '--tw-ring-color': accentColor }}
                    placeholder="e.g. US"
                  />
                  {availableCountries && availableCountries.length > 0 && (
                    <div className={`mt-1 text-[10px] ${darkMode ? 'text-slate-400' : 'text-slate-500'}`}>
                      Available in current results: {availableCountries.slice(0, 10).join(', ')}
                      {availableCountries.length > 10 && '‚Ä¶'}
                    </div>
                  )}
                </div>

                <div className="grid grid-cols-2 gap-3">
                  <div className="space-y-1.5">
                    <div className={`font-semibold ${darkMode ? 'text-slate-300' : 'text-slate-700'}`}>Budget (movies)</div>
                    <div className="flex items-center gap-1">
                      <input
                        type="number"
                        min="0"
                        step="1000000"
                        value={filters.budgetMin === '' ? '' : filters.budgetMin}
                        onChange={e => handleNumericChange('budgetMin', e.target.value)}
                        className={`w-full rounded-md border ${darkMode ? 'border-slate-700 bg-slate-900 text-slate-100' : 'border-slate-300 bg-white text-slate-900'} px-1.5 py-0.5 text-[11px] focus:outline-none focus:ring-1`}
                        style={{ '--tw-ring-color': accentColor }}
                        placeholder="Min ($)"
                      />
                    </div>
                    <input
                      type="number"
                      min="0"
                      step="1000000"
                      value={filters.budgetMax === '' ? '' : filters.budgetMax}
                      onChange={e => handleNumericChange('budgetMax', e.target.value)}
                      className={`w-full rounded-md border ${darkMode ? 'border-slate-700 bg-slate-900 text-slate-100' : 'border-slate-300 bg-white text-slate-900'} px-1.5 py-0.5 text-[11px] focus:outline-none focus:ring-1`}
                      style={{ '--tw-ring-color': accentColor }}
                      placeholder="Max ($)"
                    />
                  </div>

                  <div className="space-y-1.5">
                    <div className={`font-semibold ${darkMode ? 'text-slate-300' : 'text-slate-700'}`}>Lifetime gross (movies)</div>
                    <div className="flex items-center gap-1">
                      <input
                        type="number"
                        min="0"
                        step="1000000"
                        value={filters.revenueMin === '' ? '' : filters.revenueMin}
                        onChange={e => handleNumericChange('revenueMin', e.target.value)}
                        className={`w-full rounded-md border ${darkMode ? 'border-slate-700 bg-slate-900 text-slate-100' : 'border-slate-300 bg-white text-slate-900'} px-1.5 py-0.5 text-[11px] focus:outline-none focus:ring-1`}
                        style={{ '--tw-ring-color': accentColor }}
                        placeholder="Min ($)"
                      />
                    </div>
                    <input
                      type="number"
                      min="0"
                      step="1000000"
                      value={filters.revenueMax === '' ? '' : filters.revenueMax}
                      onChange={e => handleNumericChange('revenueMax', e.target.value)}
                      className={`w-full rounded-md border ${darkMode ? 'border-slate-700 bg-slate-900 text-slate-100' : 'border-slate-300 bg-white text-slate-900'} px-1.5 py-0.5 text-[11px] focus:outline-none focus:ring-1`}
                      style={{ '--tw-ring-color': accentColor }}
                      placeholder="Max ($)"
                    />
                  </div>
                </div>

                {(filters.budgetMin || filters.budgetMax || filters.revenueMin || filters.revenueMax) && (
                  <div className={`rounded-lg border px-2.5 py-1.5 text-[11px] ${darkMode ? 'border-amber-500/60 bg-amber-900/40 text-amber-100' : 'border-amber-400 bg-amber-50 text-amber-800'}`}>
                    Budget and lifetime gross filters apply to movies only. Titles without this data will be hidden while these filters are active.
                  </div>
                )}

                <div className="pt-1">
                  <button
                    type="button"
                    onClick={onClearFilters}
                    className={`w-full rounded-md border px-2 py-1 text-[11px] font-medium ${darkMode ? 'border-slate-700 bg-slate-900 text-slate-200 hover:bg-slate-800/80' : 'border-slate-300 bg-white text-slate-700 hover:bg-slate-100'}`}
                  >
                    Clear all filters
                  </button>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    function Header({
      viewMode,
      onChangeViewMode,
      searchQuery,
      onSearchChange,
      onSubmitSearch,
      onClearSearch,
      watchlistCounts,
      darkMode,
      onToggleTheme
    }) {
      const handleSubmit = (e) => {
        e.preventDefault();
        onSubmitSearch();
      };

      const totalWatchlist = Object.values(watchlistCounts || {}).reduce((sum, val) => sum + (val || 0), 0);
      const accentColor = darkMode ? 'rgb(168 85 247)' : 'rgb(6 182 212)';
      const accentHover = darkMode ? 'rgb(147 51 234)' : 'rgb(8 145 178)';

      return (
        <header className={`border-b ${darkMode ? 'border-slate-800 bg-slate-950/90' : 'border-slate-300 bg-white/90'} backdrop-blur-2xl sticky top-0 z-30`}>
          <div className="mx-auto max-w-7xl px-3 sm:px-4 lg:px-6 py-3 sm:py-3.5 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
            <div className="flex items-center gap-2 sm:gap-3">
              <div className="flex h-9 w-9 items-center justify-center rounded-xl text-white font-bold text-lg shadow-lg" 
                   style={{ 
                     background: darkMode 
                       ? 'linear-gradient(135deg, rgb(168 85 247), rgb(139 92 246))' 
                       : 'linear-gradient(135deg, rgb(6 182 212), rgb(14 165 233))' 
                   }}>
                üé¨
              </div>
              <div>
                <h1 className={`text-base sm:text-lg font-semibold ${darkMode ? 'text-white' : 'text-slate-900'}`}>
                  CineTrack
                </h1>
                <p className={`text-[11px] ${darkMode ? 'text-slate-400' : 'text-slate-600'}`}>
                  Your personal movie & TV watchlist & tracker
                </p>
              </div>
            </div>

            <div className="flex flex-col gap-2 sm:flex-row sm:items-center sm:gap-3">
              <div className="flex items-center gap-2">
                <ThemeToggle darkMode={darkMode} onToggle={onToggleTheme} />
                
                <div className={`flex items-center gap-1.5 rounded-full ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-slate-100 border-slate-300'} border p-0.5 text-[11px]`}>
                  <button
                    type="button"
                    onClick={() => onChangeViewMode('browse')}
                    className={
                      'px-2.5 py-1 rounded-full font-medium transition ' +
                      (viewMode === 'browse'
                        ? 'text-white shadow-sm'
                        : `${darkMode ? 'text-slate-200 hover:bg-slate-800' : 'text-slate-700 hover:bg-slate-300'}`)
                    }
                    style={viewMode === 'browse' ? { backgroundColor: accentColor } : {}}
                  >
                    Discover
                  </button>
                  <button
                    type="button"
                    onClick={() => onChangeViewMode('watchlist')}
                    className={
                      'px-2.5 py-1 rounded-full font-medium transition inline-flex items-center gap-1 ' +
                      (viewMode === 'watchlist'
                        ? 'text-white shadow-sm'
                        : `${darkMode ? 'text-slate-200 hover:bg-slate-800' : 'text-slate-700 hover:bg-slate-300'}`)
                    }
                    style={viewMode === 'watchlist' ? { backgroundColor: accentColor } : {}}
                  >
                    Watchlist
                    <span className={`ml-0.5 inline-flex min-w-[1.25rem] items-center justify-center rounded-full px-1 text-[10px] font-semibold ${darkMode ? 'bg-slate-900 text-slate-100' : 'bg-white text-slate-900'}`}>
                      {totalWatchlist}
                    </span>
                  </button>
                </div>
              </div>

              <form onSubmit={handleSubmit} className={`flex items-center gap-1.5 rounded-full ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-300'} border px-2 py-0.5 w-full sm:w-80`}>
                <input
                  type="text"
                  value={searchQuery}
                  onChange={e => onSearchChange(e.target.value)}
                  placeholder="Search movies & TV shows..."
                  className={`flex-1 bg-transparent px-1.5 py-1 text-xs ${darkMode ? 'text-slate-100 placeholder:text-slate-500' : 'text-slate-900 placeholder:text-slate-400'} focus:outline-none`}
                />
                {searchQuery && (
                  <button
                    type="button"
                    onClick={onClearSearch}
                    className={`rounded-full px-1 text-xs ${darkMode ? 'text-slate-400 hover:text-slate-200' : 'text-slate-500 hover:text-slate-700'}`}
                  >
                    Clear
                  </button>
                )}
                <button
                  type="submit"
                  className="rounded-full px-2 py-1 text-[11px] font-semibold text-white transition"
                  style={{ backgroundColor: accentColor }}
                  onMouseEnter={(e) => e.target.style.backgroundColor = accentHover}
                  onMouseLeave={(e) => e.target.style.backgroundColor = accentColor}
                >
                  Search
                </button>
              </form>
            </div>
          </div>
        </header>
      );
    }

    function WatchlistView({ watchlist, genreLookup, onOpenDetails, onChangeStatus, darkMode }) {
      const categories = WATCH_STATUSES.reduce((acc, s) => {
        acc[s.id] = [];
        return acc;
      }, {});

      Object.values(watchlist || {}).forEach(entry => {
        if (entry && categories[entry.status]) {
          categories[entry.status].push(entry);
        }
      });

      const accentColor = darkMode ? 'rgb(168 85 247)' : 'rgb(6 182 212)';

      return (
        <div className="space-y-5">
          {WATCH_STATUSES.map(cat => {
            const items = categories[cat.id] || [];
            return (
              <section key={cat.id} className="fade-in">
                <div className="mb-2 flex items-baseline justify-between">
                  <h2 className={`text-sm font-semibold ${darkMode ? 'text-white' : 'text-slate-900'}`}>
                    {cat.label}
                  </h2>
                  <span className={`text-xs ${darkMode ? 'text-slate-400' : 'text-slate-600'}`}>
                    {items.length} title{items.length === 1 ? '' : 's'}
                  </span>
                </div>
                {items.length === 0 ? (
                  <div className={`rounded-xl border border-dashed ${darkMode ? 'border-slate-800 bg-slate-900/60 text-slate-400' : 'border-slate-300 bg-slate-100/60 text-slate-500'} px-3 py-4 text-xs`}>
                    No titles in this category yet.
                  </div>
                ) : (
                  <div className="grid grid-cols-2 gap-3 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5">
                    {items.map(entry => (
                      <ItemCard
                        key={getItemKey(entry)}
                        item={entry}
                        genreLookup={genreLookup}
                        onOpenDetails={onOpenDetails}
                        watchStatus={entry.status}
                        onChangeStatus={status => onChangeStatus(entry, status)}
                        darkMode={darkMode}
                      />
                    ))}
                  </div>
                )}
              </section>
            );
          })}
        </div>
      );
    }

    function BrowseGrid({
      items,
      genreLookup,
      watchlist,
      onChangeStatus,
      onOpenDetails,
      loading,
      error,
      darkMode
    }) {
      const hasResults = items && items.length > 0;

      if (loading && !hasResults) {
        return (
          <div className={`flex min-h-[200px] items-center justify-center text-sm ${darkMode ? 'text-slate-300' : 'text-slate-600'}`}>
            Loading titles from TMDB‚Ä¶
          </div>
        );
      }

      if (error && !hasResults) {
        return (
          <div className={`rounded-xl border px-4 py-3 text-sm ${darkMode ? 'border-red-500/70 bg-red-950/40 text-red-100' : 'border-red-500/70 bg-red-50 text-red-800'}`}>
            {error}
          </div>
        );
      }

      if (!hasResults) {
        return (
          <div className={`rounded-xl border ${darkMode ? 'border-slate-800 bg-slate-900/70 text-slate-300' : 'border-slate-300 bg-slate-100/70 text-slate-600'} px-4 py-4 text-sm`}>
            No titles found for the current filters and search. Try adjusting your filters or search term.
          </div>
        );
      }

      return (
        <>
          {error && (
            <div className={`mb-3 rounded-lg border px-3 py-2 text-xs ${darkMode ? 'border-amber-500/70 bg-amber-950/40 text-amber-100' : 'border-amber-400 bg-amber-50 text-amber-800'}`}>
              {error}
            </div>
          )}
          <div className="grid grid-cols-2 gap-3 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5">
            {items.map(item => {
              const key = getItemKey(item);
              const status = watchlist[key]?.status || null;
              return (
                <ItemCard
                  key={key}
                  item={item}
                  genreLookup={genreLookup}
                  onOpenDetails={onOpenDetails}
                  watchStatus={status}
                  onChangeStatus={newStatus => onChangeStatus(item, newStatus)}
                  darkMode={darkMode}
                />
              );
            })}
          </div>
        </>
      );
    }

    function App() {
      const [darkMode, setDarkMode] = useState(false);
      const [items, setItems] = useState([]);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);

      const [searchQuery, setSearchQuery] = useState('');
      const [pendingSearch, setPendingSearch] = useState('');
      const [browseMode, setBrowseMode] = useState('popular'); // 'popular' | 'upcoming'
      const [contentType, setContentType] = useState('all'); // 'all' | 'movie' | 'tv'
      const [viewMode, setViewMode] = useState('browse');

      const [genres, setGenres] = useState({ movie: [], tv: [], combined: [] });
      const [filters, setFilters] = useState({
        selectedGenres: [],
        ratingMin: '',
        ratingMax: '',
        yearMin: '',
        yearMax: '',
        country: '',
        budgetMin: '',
        budgetMax: '',
        revenueMin: '',
        revenueMax: '',
      });

      const [watchlist, setWatchlist] = useState(() => loadWatchlistFromStorage());
      const [selectedItem, setSelectedItem] = useState(null);
      const [detailLoading, setDetailLoading] = useState(false);
      const [detailError, setDetailError] = useState(null);
      
      // New state for carousel data
      const [carouselData, setCarouselData] = useState({
        topRated: [],
        nowPlaying: [],
        trendingTV: [],
        upcomingMovies: [],
        upcomingTV: [],
        boxOffice: []
      });
      const [carouselLoading, setCarouselLoading] = useState(true);

      const apiKeyMissing = !TMDB_API_KEY || TMDB_API_KEY.startsWith('REPLACE_WITH');

      // Theme effect
      useEffect(() => {
        const body = document.getElementById('theme-body');
        if (darkMode) {
          body.classList.remove('bg-slate-50', 'text-slate-900');
          body.classList.add('bg-slate-950', 'text-slate-100');
          body.classList.add('dark-scrollbar');
          body.classList.remove('light-scrollbar');
        } else {
          body.classList.remove('bg-slate-950', 'text-slate-100');
          body.classList.add('bg-slate-50', 'text-slate-900');
          body.classList.add('light-scrollbar');
          body.classList.remove('dark-scrollbar');
        }
      }, [darkMode]);

      // Load carousel data
      useEffect(() => {
        if (apiKeyMissing) return;
        
        const loadCarouselData = async () => {
          setCarouselLoading(true);
          try {
            const [
              topRatedMovies,
              nowPlayingMovies,
              trendingTVShows,
              upcomingMovies,
              upcomingTVShows,
              boxOfficeMovies
            ] = await Promise.all([
              fetchFromTMDB('/movie/top_rated', { page: 1 }).then(d => d.results || []).catch(() => []),
              fetchFromTMDB('/movie/now_playing', { page: 1 }).then(d => d.results || []).catch(() => []),
              fetchFromTMDB('/trending/tv/week', { page: 1 }).then(d => d.results || []).catch(() => []),
              fetchFromTMDB('/movie/upcoming', { page: 1 }).then(d => d.results || []).catch(() => []),
              fetchFromTMDB('/tv/on_the_air', { page: 1 }).then(d => d.results || []).catch(() => []),
              fetchFromTMDB('/movie/popular', { 
                sort_by: 'revenue.desc',
                page: 1 
              }).then(d => d.results || []).catch(() => [])
            ]);

            setCarouselData({
              topRated: normalizeResults(topRatedMovies, 'movie'),
              nowPlaying: normalizeResults(nowPlayingMovies, 'movie'),
              trendingTV: normalizeResults(trendingTVShows, 'tv'),
              upcomingMovies: normalizeResults(upcomingMovies, 'movie'),
              upcomingTV: normalizeResults(upcomingTVShows, 'tv'),
              boxOffice: normalizeResults(boxOfficeMovies, 'movie')
            });
          } catch (e) {
            console.error('Failed to load carousel data', e);
          } finally {
            setCarouselLoading(false);
          }
        };

        loadCarouselData();
      }, [apiKeyMissing]);

      useEffect(() => {
        (async () => {
          try {
            const [movieGenres, tvGenres] = await Promise.all([
              fetchFromTMDB('/genre/movie/list').then(d => d.genres || []).catch(() => []),
              fetchFromTMDB('/genre/tv/list').then(d => d.genres || []).catch(() => []),
            ]);
            const map = {};
            movieGenres.forEach(g => {
              map[g.id] = { id: g.id, name: g.name, movie: true, tv: false };
            });
            tvGenres.forEach(g => {
              if (map[g.id]) {
                map[g.id].tv = true;
              } else {
                map[g.id] = { id: g.id, name: g.name, movie: false, tv: true };
              }
            });
            const combined = Object.values(map).sort((a, b) => a.name.localeCompare(b.name));
            setGenres({ movie: movieGenres, tv: tvGenres, combined });
          } catch (e) {
            console.warn('Failed to load genres', e);
          }
        })();
      }, []);

      useEffect(() => {
        if (apiKeyMissing) return;
        fetchItems({ reset: true });
        // eslint-disable-next-line react-hooks/exhaustive-deps
      }, [browseMode, contentType]);

      useEffect(() => {
        try {
          localStorage.setItem('watchlist_v1', JSON.stringify(watchlist));
        } catch (e) {
          console.warn('Failed to persist watchlist', e);
        }
      }, [watchlist]);

      const genreLookup = useMemo(() => {
        const map = {};
        (genres.combined || []).forEach(g => {
          map[g.id] = g.name;
        });
        return map;
      }, [genres]);

      const availableCountries = useMemo(() => {
        const set = new Set();
        (items || []).forEach(item => {
          if (Array.isArray(item.originCountry)) {
            item.originCountry.forEach(c => {
              if (c) set.add(c.toUpperCase());
            });
          }
        });
        return Array.from(set).sort();
      }, [items]);

      const updateFilters = (patch) => {
        setFilters(prev => ({ ...prev, ...patch }));
      };

      const clearFilters = () => {
        setFilters({
          selectedGenres: [],
          ratingMin: '',
          ratingMax: '',
          yearMin: '',
          yearMax: '',
          country: '',
          budgetMin: '',
          budgetMax: '',
          revenueMin: '',
          revenueMax: '',
        });
      };

      const handleSearchSubmit = () => {
        setSearchQuery(pendingSearch.trim());
        fetchItems({ reset: true, queryOverride: pendingSearch.trim() });
      };

      const handleClearSearch = () => {
        setPendingSearch('');
        setSearchQuery('');
        fetchItems({ reset: true, queryOverride: '' });
      };

      async function fetchItems({ reset = false, queryOverride = null } = {}) {
        if (apiKeyMissing) {
          setError('TMDB API key is not configured. Open index.html and set TMDB_API_KEY to your key from themoviedb.org.');
          return;
        }
        setLoading(true);
        setError(null);
        const query = queryOverride !== null ? queryOverride : searchQuery;
        try {
          let results = [];
          if (query) {
            if (contentType === 'all') {
              const data = await fetchFromTMDB('/search/multi', {
                query,
                include_adult: false,
              });
              results = (data.results || []).filter(r => r.media_type === 'movie' || r.media_type === 'tv');
            } else if (contentType === 'movie') {
              const data = await fetchFromTMDB('/search/movie', {
                query,
                include_adult: false,
              });
              results = data.results || [];
            } else {
              const data = await fetchFromTMDB('/search/tv', {
                query,
              });
              results = data.results || [];
            }
          } else {
            if (browseMode === 'popular') {
              if (contentType === 'all') {
                const data = await fetchFromTMDB('/trending/all/week', {});
                results = data.results || [];
              } else if (contentType === 'movie') {
                const data = await fetchFromTMDB('/discover/movie', {
                  sort_by: 'popularity.desc',
                  include_adult: false,
                });
                results = data.results || [];
              } else {
                const data = await fetchFromTMDB('/discover/tv', {
                  sort_by: 'popularity.desc',
                });
                results = data.results || [];
              }
            } else {
              if (contentType === 'all') {
                const [movie, tv] = await Promise.all([
                  fetchFromTMDB('/movie/upcoming', { region: 'US' }).catch(() => ({ results: [] })),
                  fetchFromTMDB('/tv/on_the_air', { }).catch(() => ({ results: [] })),
                ]);
                const m = (movie.results || []).map(r => ({ ...r, media_type: 'movie' }));
                const t = (tv.results || []).map(r => ({ ...r, media_type: 'tv' }));
                results = [...m, ...t];
              } else if (contentType === 'movie') {
                const data = await fetchFromTMDB('/movie/upcoming', { region: 'US' });
                results = data.results || [];
              } else {
                const data = await fetchFromTMDB('/tv/on_the_air', {});
                results = data.results || [];
              }
            }
          }
          const normalized = normalizeResults(results, contentType === 'all' ? null : contentType);
          setItems(normalized);
        } catch (e) {
          console.error(e);
          setError(e.message || 'Failed to load titles from TMDB.');
          if (reset) {
            setItems([]);
          }
        } finally {
          setLoading(false);
        }
      }

      async function loadDetailsForItem(item) {
        if (!item) return;
        const key = getItemKey(item);
        const alreadyDetailed = (selectedItem && getItemKey(selectedItem) === key && selectedItem.detailLoaded) ||
          items.some(it => getItemKey(it) === key && it.detailLoaded) ||
          (watchlist[key] && watchlist[key].detailLoaded);

        if (alreadyDetailed) {
          return;
        }

        setDetailLoading(true);
        setDetailError(null);
        try {
          const path = item.type === 'movie' ? `/movie/${item.id}` : `/tv/${item.id}`;
          const append = item.type === 'movie' ? 'release_dates,videos' : 'content_ratings,videos';
          const raw = await fetchFromTMDB(path, { append_to_response: append });

          const runtime = item.type === 'movie'
            ? (typeof raw.runtime === 'number' ? raw.runtime : null)
            : (Array.isArray(raw.episode_run_time) && raw.episode_run_time.length ? raw.episode_run_time[0] : null);
          const budget = item.type === 'movie' ? (typeof raw.budget === 'number' ? raw.budget : null) : null;
          const revenue = item.type === 'movie' ? (typeof raw.revenue === 'number' ? raw.revenue : null) : null;
          const productionCountries = Array.isArray(raw.production_countries)
            ? raw.production_countries.map(c => c.iso_3166_1).filter(Boolean)
            : [];
          const originCountry = productionCountries.length
            ? productionCountries
            : (Array.isArray(raw.origin_country) && raw.origin_country.length ? raw.origin_country : item.originCountry || []);

          const certification = extractCertification(
            {
              ...raw,
              release_dates: raw.release_dates,
              content_ratings: raw.content_ratings,
              adult: raw.adult,
            },
            item.type,
            originCountry
          );
          const trailerKey = extractTrailerKey(raw);
          const genresFull = Array.isArray(raw.genres) ? raw.genres : (item.genresFull || []);
          const overview = raw.overview || item.overview;
          const backdropPath = raw.backdrop_path || item.backdropPath;
          const posterPath = raw.poster_path || item.posterPath;
          const voteAverage = typeof raw.vote_average === 'number' ? raw.vote_average : item.voteAverage;
          const voteCount = typeof raw.vote_count === 'number' ? raw.vote_count : item.voteCount;
          const releaseDate = item.type === 'movie'
            ? (raw.release_date || item.releaseDate)
            : (raw.first_air_date || item.releaseDate);
          const year = releaseDate ? parseInt(releaseDate.slice(0, 4), 10) : item.year;

          const detailPatch = {
            runtime,
            budget,
            revenue,
            originCountry,
            certification,
            trailerKey,
            genresFull,
            overview,
            backdropPath,
            posterPath,
            voteAverage,
            voteCount,
            releaseDate,
            year,
            detailLoaded: true,
          };

          setItems(prev =>
            prev.map(it =>
              getItemKey(it) === key ? { ...it, ...detailPatch } : it
            )
          );
          setSelectedItem(prev =>
            prev && getItemKey(prev) === key ? { ...prev, ...detailPatch } : prev
          );
          setWatchlist(prev => {
            if (!prev[key]) return prev;
            return {
              ...prev,
              [key]: { ...prev[key], ...detailPatch },
            };
          });
        } catch (e) {
          console.error(e);
          setDetailError(e.message || 'Failed to load detailed metadata.');
          setItems(prev =>
            prev.map(it =>
              getItemKey(it) === key ? { ...it, detailLoaded: false, detailError: e.message || 'Failed to load details.' } : it
            )
          );
        } finally {
          setDetailLoading(false);
        }
      }

      const handleOpenDetails = (item) => {
        setSelectedItem(item);
        setDetailError(null);
        if (!item.detailLoaded) {
          loadDetailsForItem(item);
        }
      };

      const handleChangeStatus = (item, status) => {
        const key = getItemKey(item);
        setWatchlist(prev => {
          const next = { ...prev };
          if (!status) {
            delete next[key];
            return next;
          }
          const existing = prev[key] || {};
          next[key] = {
            ...existing,
            ...item,
            status,
            updatedAt: new Date().toISOString(),
          };
          return next;
        });
      };

      const filteredItems = useMemo(() => {
        return (items || []).filter(item => {
          if (contentType !== 'all' && item.type !== contentType) return false;

          const selectedGenres = filters.selectedGenres || [];
          if (selectedGenres.length > 0) {
            const ids = item.genre_ids || [];
            const match = selectedGenres.every(id => ids.includes(id));
            if (!match) return false;
          }

          if (filters.ratingMin !== '' && typeof filters.ratingMin === 'number') {
            if (item.voteAverage < filters.ratingMin) return false;
          }
          if (filters.ratingMax !== '' && typeof filters.ratingMax === 'number') {
            if (item.voteAverage > filters.ratingMax) return false;
          }

          const year = item.year;
          if (filters.yearMin !== '' && typeof filters.yearMin === 'number' && year) {
            if (year < filters.yearMin) return false;
          }
          if (filters.yearMax !== '' && typeof filters.yearMax === 'number' && year) {
            if (year > filters.yearMax) return false;
          }

          if (filters.country) {
            const countries = Array.isArray(item.originCountry) ? item.originCountry.map(c => c.toUpperCase()) : [];
            if (!countries.includes(filters.country.toUpperCase())) return false;
          }

          const needBudgetRevenue =
            filters.budgetMin !== '' ||
            filters.budgetMax !== '' ||
            filters.revenueMin !== '' ||
            filters.revenueMax !== '';

          if (needBudgetRevenue) {
            if (item.type !== 'movie') return false;
            if (typeof item.budget !== 'number' || typeof item.revenue !== 'number') return false;
            if (filters.budgetMin !== '' && typeof filters.budgetMin === 'number') {
              if (item.budget < filters.budgetMin) return false;
            }
            if (filters.budgetMax !== '' && typeof filters.budgetMax === 'number') {
              if (item.budget > filters.budgetMax) return false;
            }
            if (filters.revenueMin !== '' && typeof filters.revenueMin === 'number') {
              if (item.revenue < filters.revenueMin) return false;
            }
            if (filters.revenueMax !== '' && typeof filters.revenueMax === 'number') {
              if (item.revenue > filters.revenueMax) return false;
            }
          }

          return true;
        });
      }, [items, filters, contentType]);

      const watchlistCounts = useMemo(() => {
        const counts = {};
        WATCH_STATUSES.forEach(s => { counts[s.id] = 0; });
        Object.values(watchlist || {}).forEach(entry => {
          if (entry && entry.status && counts.hasOwnProperty(entry.status)) {
            counts[entry.status] += 1;
          }
        });
        return counts;
      }, [watchlist]);

      const accentColor = darkMode ? 'rgb(168 85 247)' : 'rgb(6 182 212)';

      return (
        <div className={`min-h-screen theme-transition ${darkMode ? 'bg-slate-950 text-slate-100' : 'bg-slate-50 text-slate-900'}`}>
          {apiKeyMissing && (
            <div className={`text-xs text-center px-4 py-2 ${darkMode ? 'bg-red-700 text-red-50' : 'bg-red-100 text-red-800'}`}>
              TMDB API key is not configured. Open <code className="font-mono text-[11px]">index.html</code> and replace
              <span className="mx-1 font-mono text-[11px]">TMDB_API_KEY</span>
              with your personal key from themoviedb.org. No external server is required.
            </div>
          )}

          <Header
            viewMode={viewMode}
            onChangeViewMode={setViewMode}
            searchQuery={pendingSearch}
            onSearchChange={setPendingSearch}
            onSubmitSearch={handleSearchSubmit}
            onClearSearch={handleClearSearch}
            watchlistCounts={watchlistCounts}
            darkMode={darkMode}
            onToggleTheme={() => setDarkMode(!darkMode)}
          />

          <main className="mx-auto max-w-7xl px-3 sm:px-4 lg:px-6 py-4 sm:py-6 flex flex-col gap-4 sm:gap-6">
            {viewMode === 'browse' && !searchQuery && (
              <>
                {/* Hero Slider */}
                <HeroSlider 
                  items={[...carouselData.topRated, ...carouselData.nowPlaying].slice(0, 10)} 
                  onOpenDetails={handleOpenDetails}
                  darkMode={darkMode}
                />
                
                {/* Carousel Sections - Arranged in logical order */}
                {!carouselLoading && (
                  <div className="space-y-10 fade-in">
                    <CarouselSection
                      title="Critically Acclaimed"
                      items={carouselData.topRated.slice(0, 20)}
                      onOpenDetails={handleOpenDetails}
                      genreLookup={genreLookup}
                      darkMode={darkMode}
                      accentColor={accentColor}
                    />
                    
                    <CarouselSection
                      title="Now in Theaters"
                      items={carouselData.nowPlaying.slice(0, 20)}
                      onOpenDetails={handleOpenDetails}
                      genreLookup={genreLookup}
                      darkMode={darkMode}
                      accentColor={accentColor}
                    />
                    
                    <CarouselSection
                      title="Trending TV Series"
                      items={carouselData.trendingTV.slice(0, 20)}
                      onOpenDetails={handleOpenDetails}
                      genreLookup={genreLookup}
                      darkMode={darkMode}
                      accentColor={accentColor}
                    />
                    
                    <CarouselSection
                      title="Coming Soon to Theaters"
                      items={carouselData.upcomingMovies.slice(0, 20)}
                      onOpenDetails={handleOpenDetails}
                      genreLookup={genreLookup}
                      darkMode={darkMode}
                      accentColor={accentColor}
                    />
                    
                    <CarouselSection
                      title="New TV Seasons"
                      items={carouselData.upcomingTV.slice(0, 20)}
                      onOpenDetails={handleOpenDetails}
                      genreLookup={genreLookup}
                      darkMode={darkMode}
                      accentColor={accentColor}
                    />
                    
                    <CarouselSection
                      title="Box Office Hits"
                      items={carouselData.boxOffice.slice(0, 20)}
                      onOpenDetails={handleOpenDetails}
                      genreLookup={genreLookup}
                      darkMode={darkMode}
                      accentColor={accentColor}
                    />
                  </div>
                )}
                
                {/* Browse grid for filtered content */}
                <div className="mt-10">
                  <h2 className={`text-2xl font-bold mb-6 ${darkMode ? 'text-white' : 'text-slate-900'}`}>
                    Browse All Content
                  </h2>
                  <div className="grid gap-4 lg:grid-cols-[minmax(0,260px)_minmax(0,1fr)]">
                    <aside className="order-2 lg:order-1">
                      <FiltersPanel
                        genres={genres.combined || []}
                        filters={filters}
                        onUpdateFilters={updateFilters}
                        contentType={contentType}
                        onChangeContentType={setContentType}
                        browseMode={browseMode}
                        onChangeBrowseMode={mode => {
                          setBrowseMode(mode);
                          fetchItems({ reset: true, queryOverride: '' });
                        }}
                        availableCountries={availableCountries}
                        onClearFilters={clearFilters}
                        darkMode={darkMode}
                      />
                      <div className={`mt-4 rounded-xl border ${darkMode ? 'border-slate-800 bg-slate-900/80 text-slate-400' : 'border-slate-300 bg-slate-100/80 text-slate-600'} px-3 py-2 text-[11px]`}>
                        <div className={`font-semibold text-xs mb-1 ${darkMode ? 'text-slate-300' : 'text-slate-700'}`}>
                          Data & trailers
                        </div>
                        <p>
                          Metadata and trailers are fetched live from TMDB. This application is intended for private, single-user use only.
                        </p>
                        <p className="mt-1">
                          Budget and lifetime gross values are shown for movies where TMDB provides this data.
                        </p>
                      </div>
                    </aside>

                    <section className="order-1 lg:order-2 space-y-4">
                      <BrowseGrid
                        items={filteredItems}
                        genreLookup={genreLookup}
                        watchlist={watchlist}
                        onChangeStatus={handleChangeStatus}
                        onOpenDetails={handleOpenDetails}
                        loading={loading}
                        error={error}
                        darkMode={darkMode}
                      />
                    </section>
                  </div>
                </div>
              </>
            )}
            
            {viewMode === 'browse' && searchQuery && (
              <div className="grid gap-4 lg:grid-cols-[minmax(0,260px)_minmax(0,1fr)]">
                <aside className="order-2 lg:order-1">
                  <FiltersPanel
                    genres={genres.combined || []}
                    filters={filters}
                    onUpdateFilters={updateFilters}
                    contentType={contentType}
                    onChangeContentType={setContentType}
                    browseMode={browseMode}
                    onChangeBrowseMode={mode => {
                      setBrowseMode(mode);
                      fetchItems({ reset: true, queryOverride: '' });
                    }}
                    availableCountries={availableCountries}
                    onClearFilters={clearFilters}
                    darkMode={darkMode}
                  />
                </aside>

                <section className="order-1 lg:order-2 space-y-4">
                  <h2 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-slate-900'}`}>
                    Search Results for "{searchQuery}"
                  </h2>
                  <BrowseGrid
                    items={filteredItems}
                    genreLookup={genreLookup}
                    watchlist={watchlist}
                    onChangeStatus={handleChangeStatus}
                    onOpenDetails={handleOpenDetails}
                    loading={loading}
                    error={error}
                    darkMode={darkMode}
                  />
                </section>
              </div>
            )}
            
            {viewMode === 'watchlist' && (
              <div className="grid gap-4 lg:grid-cols-[minmax(0,260px)_minmax(0,1fr)]">
                <aside className="order-2 lg:order-1">
                  <FiltersPanel
                    genres={genres.combined || []}
                    filters={filters}
                    onUpdateFilters={updateFilters}
                    contentType={contentType}
                    onChangeContentType={setContentType}
                    browseMode={browseMode}
                    onChangeBrowseMode={mode => {
                      setBrowseMode(mode);
                      fetchItems({ reset: true, queryOverride: '' });
                    }}
                    availableCountries={availableCountries}
                    onClearFilters={clearFilters}
                    darkMode={darkMode}
                  />
                </aside>

                <section className="order-1 lg:order-2 space-y-4">
                  <h2 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-slate-900'}`}>
                    My Watchlist
                  </h2>
                  <WatchlistView
                    watchlist={watchlist}
                    genreLookup={genreLookup}
                    onOpenDetails={handleOpenDetails}
                    onChangeStatus={handleChangeStatus}
                    darkMode={darkMode}
                  />
                </section>
              </div>
            )}

            <footer className={`border-t ${darkMode ? 'border-slate-800' : 'border-slate-300'} pt-3 mt-3 text-[11px] flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1`}>
              <div className={darkMode ? 'text-slate-500' : 'text-slate-600'}>
                This product uses the TMDB API but is not endorsed or certified by TMDB.
              </div>
              <div className={darkMode ? 'text-slate-500' : 'text-slate-600'}>
                All data remains in your browser (single-user, private watchlist).
              </div>
            </footer>
          </main>

          <DetailModal
            item={selectedItem}
            onClose={() => {
              setSelectedItem(null);
              setDetailError(null);
            }}
            loading={detailLoading}
            error={detailError}
            darkMode={darkMode}
          />
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
